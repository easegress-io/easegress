# Web Application Firewall

- [Introduction](#introduction)
- [Configuring Web Application Firewall](#configuring-web-application-firewall)
- [Observability](#observability)

## Introduction

The Web Application Firewall (WAF) protects your apps by inspecting HTTP(S) traffic and blocking malicious requests at the application layer. It supports standard rule sets like OWASP CRS and flexible custom policies.

Beyond basic request filtering, the WAF includes IP/Geo access control, rate limiting, and rich observability for tuning and incident response. This ensures strong protection with low false positives and clear operational insight.

## Configuring Web Application Firewall

Here is a simple example shows how to configure Easegress to protect your backend using a WAF with a minimal subset of the OWASP Core Rule Set (CRS) focused on SQL Injection (SQLi) detection.

```yaml
name: waf-controller
kind: WAFController
ruleGroups:
- name: sqlinjection
  rules:
    customRules: |
      // https://github.com/corazawaf/coraza-coreruleset/blob/main/rules/%40crs-setup.conf.example
      // check coraza core rule set recommend setup file 
    owaspRules:
    - REQUEST-901-INITIALIZATION.conf
    - REQUEST-942-APPLICATION-ATTACK-SQLI.conf
    - REQUEST-949-BLOCKING-EVALUATION.conf

------

name: waf-server
kind: HTTPServer
port: 10080
rules:
- paths: 
  - pathPrefix: /
    backend: waf-pipeline

-----

name: waf-pipeline
kind: Pipeline
filters:
- name: waf-filter
  kind: WAF
  ruleGroup: sqlinjection
- name: proxy
  kind: Proxy
  pools:
  - servers:
    - url: http://127.0.0.1:9095
    - url: http://127.0.0.1:9096
    loadBalance:
      policy: roundRobin
```

It will do following things:
1. Loads a minimal, SQLi-focused subset of the OWASP CRS:
    - 901: Initialization and variable setup
    - 942: SQL Injection detection
    - 949: Final blocking evaluation
2. Routes traffic to port 10080 through the waf-pipeline, where the WAF filter evaluates requests against the sqlinjection rule group before proxying to your backend pool.


### Custom 

This example shows how to load the full OWASP Core Rule Set (CRS) and add your own custom Coraza/ModSecurity rules in Easegress. The example below blocks all POST requests at both `phase 1` and `phase 2` for demonstration purposes.

```yaml
name: waf-controller
kind: WAFController
ruleGroups:
- name: sqlinjection
  rules:
    loadOwaspCrs: true
    customRules: |
      SecRule REQUEST_METHOD "POST" "id:1000001,phase:1,block,log,msg:'Block all POST requests (phase 1)',severity:'CRITICAL'"
      SecRule REQUEST_METHOD "POST" "id:1000002,phase:2,block,log,msg:'Block all POST requests (phase 2)',severity:'CRITICAL'"
```

What this does:
- `loadOwaspCrs`: true loads the full OWASP CRS bundle. You can includes them as you needed. For full rule set, please check: [here](https://github.com/corazawaf/coraza-coreruleset/tree/main/rules/%40owasp_crs).
- `customRules` adds two rules that explicitly block all POST requests. They run in different phases to illustrate the request processing lifecycle. For more details about Coraza/Modsecurity rules please check: [here](https://coraza.io/docs/seclang/)

Feel free to add your own rules as needed.

### OWASP Core Rule Set

### IP Blocker

### GEO IP Blocker

### Rate Limiter


## Observability